{"ast":null,"code":"/**\n * Module requirements.\n */\nvar XMLHttpRequest = require('xmlhttprequest-ssl');\n\nvar Polling = require('./polling');\n\nvar Emitter = require('component-emitter');\n\nvar inherit = require('component-inherit');\n\nvar debug = require('debug')('engine.io-client:polling-xhr');\n/**\n * Module exports.\n */\n\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n/**\n * Empty function\n */\n\nfunction empty() {}\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\n\nfunction XHR(opts) {\n  Polling.call(this, opts);\n\n  if (global.location) {\n    var isSSL = 'https:' == location.protocol;\n    var port = location.port; // some user agents have empty `location.port`\n\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = opts.hostname != global.location.hostname || port != opts.port;\n    this.xs = opts.secure != isSSL;\n  } else {\n    this.extraHeaders = opts.extraHeaders;\n  }\n}\n/**\n * Inherits from Polling.\n */\n\n\ninherit(XHR, Polling);\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function (opts) {\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR; // SSL options for Node.js client\n\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized; // other options for Node.js client\n\n  opts.extraHeaders = this.extraHeaders;\n  return new Request(opts);\n};\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\n\nXHR.prototype.doWrite = function (data, fn) {\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({\n    method: 'POST',\n    data: data,\n    isBinary: isBinary\n  });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function (err) {\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\n\nXHR.prototype.doPoll = function () {\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function (data) {\n    self.onData(data);\n  });\n  req.on('error', function (err) {\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\n\nfunction Request(opts) {\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined != opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR; // SSL options for Node.js client\n\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized; // other options for Node.js client\n\n  this.extraHeaders = opts.extraHeaders;\n  this.create();\n}\n/**\n * Mix in `Emitter`.\n */\n\n\nEmitter(Request.prototype);\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function () {\n  var opts = {\n    agent: this.agent,\n    xdomain: this.xd,\n    xscheme: this.xs,\n    enablesXDR: this.enablesXDR\n  }; // SSL options for Node.js client\n\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n\n    try {\n      if (this.extraHeaders) {\n        xhr.setDisableHeaderCheck(true);\n\n        for (var i in this.extraHeaders) {\n          if (this.extraHeaders.hasOwnProperty(i)) {\n            xhr.setRequestHeader(i, this.extraHeaders[i]);\n          }\n        }\n      }\n    } catch (e) {}\n\n    if (this.supportsBinary) {\n      // This has to be done after open because Firefox is stupid\n      // http://stackoverflow.com/questions/13216903/get-binary-data-with-xmlhttprequest-in-a-firefox-extension\n      xhr.responseType = 'arraybuffer';\n    }\n\n    if ('POST' == this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    } // ie6 check\n\n\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = true;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function () {\n        self.onLoad();\n      };\n\n      xhr.onerror = function () {\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function () {\n        if (4 != xhr.readyState) return;\n\n        if (200 == xhr.status || 1223 == xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function () {\n            self.onError(xhr.status);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function () {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (global.document) {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\n\nRequest.prototype.onSuccess = function () {\n  this.emit('success');\n  this.cleanup();\n};\n/**\n * Called if we have data.\n *\n * @api private\n */\n\n\nRequest.prototype.onData = function (data) {\n  this.emit('data', data);\n  this.onSuccess();\n};\n/**\n * Called upon error.\n *\n * @api private\n */\n\n\nRequest.prototype.onError = function (err) {\n  this.emit('error', err);\n  this.cleanup(true);\n};\n/**\n * Cleans up house.\n *\n * @api private\n */\n\n\nRequest.prototype.cleanup = function (fromError) {\n  if ('undefined' == typeof this.xhr || null === this.xhr) {\n    return;\n  } // xmlhttprequest\n\n\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch (e) {}\n  }\n\n  if (global.document) {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n/**\n * Called upon load.\n *\n * @api private\n */\n\n\nRequest.prototype.onLoad = function () {\n  var data;\n\n  try {\n    var contentType;\n\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type').split(';')[0];\n    } catch (e) {}\n\n    if (contentType === 'application/octet-stream') {\n      data = this.xhr.response;\n    } else {\n      if (!this.supportsBinary) {\n        data = this.xhr.responseText;\n      } else {\n        try {\n          data = String.fromCharCode.apply(null, new Uint8Array(this.xhr.response));\n        } catch (e) {\n          var ui8Arr = new Uint8Array(this.xhr.response);\n          var dataArray = [];\n\n          for (var idx = 0, length = ui8Arr.length; idx < length; idx++) {\n            dataArray.push(ui8Arr[idx]);\n          }\n\n          data = String.fromCharCode.apply(null, dataArray);\n        }\n      }\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n\n  if (null != data) {\n    this.onData(data);\n  }\n};\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\n\nRequest.prototype.hasXDR = function () {\n  return 'undefined' !== typeof global.XDomainRequest && !this.xs && this.enablesXDR;\n};\n/**\n * Aborts the request.\n *\n * @api public\n */\n\n\nRequest.prototype.abort = function () {\n  this.cleanup();\n};\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\n\nif (global.document) {\n  Request.requestsCount = 0;\n  Request.requests = {};\n\n  if (global.attachEvent) {\n    global.attachEvent('onunload', unloadHandler);\n  } else if (global.addEventListener) {\n    global.addEventListener('beforeunload', unloadHandler, false);\n  }\n}\n\nfunction unloadHandler() {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}","map":{"version":3,"sources":["/app/node_modules/engine.io-client/lib/transports/polling-xhr.js"],"names":["XMLHttpRequest","require","Polling","Emitter","inherit","debug","module","exports","XHR","Request","empty","opts","call","global","location","isSSL","protocol","port","xd","hostname","xs","secure","extraHeaders","prototype","supportsBinary","request","uri","agent","enablesXDR","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","doWrite","data","fn","isBinary","undefined","req","method","self","on","err","onError","sendXhr","doPoll","onData","pollXhr","async","create","xdomain","xscheme","xhr","open","setDisableHeaderCheck","i","hasOwnProperty","setRequestHeader","e","responseType","withCredentials","hasXDR","onload","onLoad","onerror","responseText","onreadystatechange","readyState","status","setTimeout","send","document","index","requestsCount","requests","onSuccess","emit","cleanup","fromError","abort","contentType","getResponseHeader","split","response","String","fromCharCode","apply","Uint8Array","ui8Arr","dataArray","idx","length","push","XDomainRequest","attachEvent","unloadHandler","addEventListener"],"mappings":"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","sourcesContent":["/**\n * Module requirements.\n */\n\nvar XMLHttpRequest = require('xmlhttprequest-ssl');\nvar Polling = require('./polling');\nvar Emitter = require('component-emitter');\nvar inherit = require('component-inherit');\nvar debug = require('debug')('engine.io-client:polling-xhr');\n\n/**\n * Module exports.\n */\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n\n/**\n * Empty function\n */\n\nfunction empty(){}\n\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\nfunction XHR(opts){\n  Polling.call(this, opts);\n\n  if (global.location) {\n    var isSSL = 'https:' == location.protocol;\n    var port = location.port;\n\n    // some user agents have empty `location.port`\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = opts.hostname != global.location.hostname ||\n      port != opts.port;\n    this.xs = opts.secure != isSSL;\n  } else {\n    this.extraHeaders = opts.extraHeaders;\n  }\n}\n\n/**\n * Inherits from Polling.\n */\n\ninherit(XHR, Polling);\n\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function(opts){\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR;\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  // other options for Node.js client\n  opts.extraHeaders = this.extraHeaders;\n\n  return new Request(opts);\n};\n\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\nXHR.prototype.doWrite = function(data, fn){\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({ method: 'POST', data: data, isBinary: isBinary });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function(err){\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\nXHR.prototype.doPoll = function(){\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function(data){\n    self.onData(data);\n  });\n  req.on('error', function(err){\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Request(opts){\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined != opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR;\n\n  // SSL options for Node.js client\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized;\n\n  // other options for Node.js client\n  this.extraHeaders = opts.extraHeaders;\n\n  this.create();\n}\n\n/**\n * Mix in `Emitter`.\n */\n\nEmitter(Request.prototype);\n\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function(){\n  var opts = { agent: this.agent, xdomain: this.xd, xscheme: this.xs, enablesXDR: this.enablesXDR };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n    try {\n      if (this.extraHeaders) {\n        xhr.setDisableHeaderCheck(true);\n        for (var i in this.extraHeaders) {\n          if (this.extraHeaders.hasOwnProperty(i)) {\n            xhr.setRequestHeader(i, this.extraHeaders[i]);\n          }\n        }\n      }\n    } catch (e) {}\n    if (this.supportsBinary) {\n      // This has to be done after open because Firefox is stupid\n      // http://stackoverflow.com/questions/13216903/get-binary-data-with-xmlhttprequest-in-a-firefox-extension\n      xhr.responseType = 'arraybuffer';\n    }\n\n    if ('POST' == this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    }\n\n    // ie6 check\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = true;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function(){\n        self.onLoad();\n      };\n      xhr.onerror = function(){\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function(){\n        if (4 != xhr.readyState) return;\n        if (200 == xhr.status || 1223 == xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function(){\n            self.onError(xhr.status);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function() {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (global.document) {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\nRequest.prototype.onSuccess = function(){\n  this.emit('success');\n  this.cleanup();\n};\n\n/**\n * Called if we have data.\n *\n * @api private\n */\n\nRequest.prototype.onData = function(data){\n  this.emit('data', data);\n  this.onSuccess();\n};\n\n/**\n * Called upon error.\n *\n * @api private\n */\n\nRequest.prototype.onError = function(err){\n  this.emit('error', err);\n  this.cleanup(true);\n};\n\n/**\n * Cleans up house.\n *\n * @api private\n */\n\nRequest.prototype.cleanup = function(fromError){\n  if ('undefined' == typeof this.xhr || null === this.xhr) {\n    return;\n  }\n  // xmlhttprequest\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch(e) {}\n  }\n\n  if (global.document) {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n\n/**\n * Called upon load.\n *\n * @api private\n */\n\nRequest.prototype.onLoad = function(){\n  var data;\n  try {\n    var contentType;\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type').split(';')[0];\n    } catch (e) {}\n    if (contentType === 'application/octet-stream') {\n      data = this.xhr.response;\n    } else {\n      if (!this.supportsBinary) {\n        data = this.xhr.responseText;\n      } else {\n        try {\n          data = String.fromCharCode.apply(null, new Uint8Array(this.xhr.response));\n        } catch (e) {\n          var ui8Arr = new Uint8Array(this.xhr.response);\n          var dataArray = [];\n          for (var idx = 0, length = ui8Arr.length; idx < length; idx++) {\n            dataArray.push(ui8Arr[idx]);\n          }\n\n          data = String.fromCharCode.apply(null, dataArray);\n        }\n      }\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n  if (null != data) {\n    this.onData(data);\n  }\n};\n\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\nRequest.prototype.hasXDR = function(){\n  return 'undefined' !== typeof global.XDomainRequest && !this.xs && this.enablesXDR;\n};\n\n/**\n * Aborts the request.\n *\n * @api public\n */\n\nRequest.prototype.abort = function(){\n  this.cleanup();\n};\n\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\nif (global.document) {\n  Request.requestsCount = 0;\n  Request.requests = {};\n  if (global.attachEvent) {\n    global.attachEvent('onunload', unloadHandler);\n  } else if (global.addEventListener) {\n    global.addEventListener('beforeunload', unloadHandler, false);\n  }\n}\n\nfunction unloadHandler() {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"script"}